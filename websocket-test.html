<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç –¢–µ—Å—Ç WebSocket - W Garage</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 10px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }
        .status-ok {
            background: #f0f9f4;
            border-left-color: #10b981;
            color: #065f46;
        }
        .status-error {
            background: #fef2f2;
            border-left-color: #ef4444;
            color: #991b1b;
        }
        .status-warning {
            background: #fffbeb;
            border-left-color: #f59e0b;
            color: #92400e;
        }
        .log {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 5px;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background: #2563eb;
        }
        .user-info {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üîç –¢–µ—Å—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π</div>
            <p>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π W Garage</p>
        </div>

        <div id="userInfo" class="user-info">
            <strong>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ...</strong>
        </div>

        <div id="statusContainer">
            <!-- –°—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω —á–µ—Ä–µ–∑ JavaScript -->
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="testWebSocket()" class="btn">üîå –¢–µ—Å—Ç WebSocket</button>
            <button onclick="sendTestMessage()" class="btn">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
            <button onclick="checkConnectedUsers()" class="btn">üë• –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö</button>
            <button onclick="clearLog()" class="btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>

        <div id="log" class="log">
            <strong>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</strong><br>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <a href="/dashboard" class="btn">üìä –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–∞–Ω–µ–ª–∏</a>
        </div>
    </div>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>

    <script>
        let socket = null;
        let logElement = document.getElementById('log');

        function log(message) {
            const time = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${time}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function checkUserInfo() {
            const token = localStorage.getItem('wgarage-token');
            const user = localStorage.getItem('wgarage-current-user');
            const userInfoDiv = document.getElementById('userInfo');

            if (!token) {
                userInfoDiv.innerHTML = `
                    <div class="status status-error">
                        <strong>‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</strong>
                        <p><a href="/login">–ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—Ö–æ–¥—É</a></p>
                    </div>
                `;
                return null;
            }

            if (user) {
                try {
                    const userData = JSON.parse(user);
                    userInfoDiv.innerHTML = `
                        <div class="status status-ok">
                            <strong>‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userData.name || userData.username}</strong>
                            <p>ID: ${userData.id || userData.username}</p>
                            <p>–î–æ–ª–∂–Ω–æ—Å—Ç—å: ${userData.position || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                            <p>–¢–æ–∫–µ–Ω: ${token.substring(0, 20)}...</p>
                        </div>
                    `;
                    return userData;
                } catch (e) {
                    userInfoDiv.innerHTML = `
                        <div class="status status-error">
                            <strong>‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</strong>
                        </div>
                    `;
                }
            }
            return null;
        }

        function testWebSocket() {
            const user = checkUserInfo();
            if (!user) {
                log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                return;
            }

            log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...');
            
            if (socket) {
                socket.disconnect();
            }

            socket = io(window.location.origin);

            socket.on('connect', () => {
                log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                const userId = user.id || user.username;
                log(`üë§ –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userId}`);
                socket.emit('userConnect', userId);
            });

            socket.on('disconnect', () => {
                log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
            });

            socket.on('newTask', (data) => {
                log(`üìã –ü–æ–ª—É—á–µ–Ω–æ newTask: ${JSON.stringify(data)}`);
            });

            socket.on('personalTask', (data) => {
                log(`üéØ –ü–æ–ª—É—á–µ–Ω–æ personalTask: ${JSON.stringify(data)}`);
                alert(`üéØ –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞: ${data.title}`);
            });

            socket.on('taskUpdate', (data) => {
                log(`üìù –ü–æ–ª—É—á–µ–Ω–æ taskUpdate: ${JSON.stringify(data)}`);
            });

            socket.on('test_response', (data) => {
                log(`üß™ –û—Ç–≤–µ—Ç –Ω–∞ —Ç–µ—Å—Ç: ${JSON.stringify(data)}`);
            });

            socket.on('connect_error', (error) => {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error}`);
            });
        }

        function sendTestMessage() {
            if (!socket || !socket.connected) {
                log('‚ùå WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
                return;
            }

            const user = checkUserInfo();
            if (!user) return;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä—É
            socket.emit('test', {
                from: user.id || user.username,
                message: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
                timestamp: new Date().toISOString()
            });

            log('üì® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
        }

        function checkConnectedUsers() {
            log('üë• –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
            
            fetch('/api/websocket-status')
                .then(response => response.json())
                .then(data => {
                    log(`üìä –í—Å–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π: ${data.totalConnections}`);
                    log(`‚è∞ –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞: ${data.serverTime}`);
                    
                    if (data.connectedUsers.length > 0) {
                        log('üë• –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:');
                        data.connectedUsers.forEach(user => {
                            log(`  - ${user.userId} (socket: ${user.socketId})`);
                        });
                    } else {
                        log('üö´ –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                    }
                })
                .catch(error => {
                    log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${error}`);
                });
        }

        function clearLog() {
            logElement.innerHTML = '<strong>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π:</strong><br>';
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            checkUserInfo();
            log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≥–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');
        });
    </script>
</body>
</html>
