// База данных ролей и их описаний для W Garage - Расширенная техническая документация
window.roleDatabase = {
    'kom-director': {
        title: 'Коммерческий директор',
        description: 'Руководство коммерческой деятельностью, развитие бизнеса и стратегическое планирование',
        knowledgeBase: {
            documents: [
                {
                    title: 'Коммерческая стратегия W Garage 2025',
                    type: 'strategy',
                    content: 'Основные направления развития коммерческой деятельности: 1) Расширение клиентской базы на 40% 2) Внедрение новых услуг по ремонту Common Rail систем 3) Развитие корпоративного сегмента 4) Цифровизация процессов продаж 5) Партнерская программа с автопарками',
                    priority: 'high',
                    created: '2025-01-15'
                },
                {
                    title: 'Планы продаж на 2025 год',
                    type: 'plan',
                    content: 'Целевые показатели: Общий оборот 15 млн руб (+25% к 2024), количество заказов 2400 (+30%), средний чек 6250 руб (+10%). Разбивка по услугам: ремонт ТНВД 60%, ремонт форсунок 25%, диагностика 10%, прочее 5%',
                    priority: 'critical',
                    created: '2025-01-10'
                }
            ],
            procedures: [
                {
                    title: 'Работа с VIP клиентами',
                    type: 'customer_service',
                    content: 'Процедура обслуживания крупных клиентов',
                    steps: [
                        'Регистрация клиента в CRM как VIP',
                        'Назначение персонального менеджера',
                        'Создание индивидуального предложения'
                    ]
                }
            ],
            tools: [
                {
                    title: 'CRM система управления клиентами',
                    type: 'software',
                    content: 'Основные функции: учет клиентов, история обращений, планирование звонков'
                }
            ]
        },
        responsibilities: [
            'Разработка коммерческой стратегии развития сервиса',
            'Контроль выполнения планов продаж и прибыли',
            'Управление отделом продаж и маркетинга'
        ],
        skills: [
            'Стратегическое мышление и планирование',
            'Знание автомобильного рынка',
            'Управление продажами'
        ],
        tools: [
            'CRM-системы',
            'Аналитические программы',
            'MS Office (Excel, PowerPoint)'
        ],
        procedures: [
            'Еженедельные планерки с отделом продаж',
            'Ежемесячный анализ финансовых показателей'
        ]
    },

    'elektrik-diagnost': {
        title: 'Электрик-диагност',
        description: 'Диагностика и ремонт электронных систем дизельных двигателей',
        knowledgeBase: {
            documents: [
                {
                    title: 'Коды ошибок дизельных двигателей',
                    type: 'reference',
                    content: `КОДЫ ОШИБОК ОСНОВНЫХ СИСТЕМ:

ТОПЛИВНАЯ СИСТЕМА COMMON RAIL:
P0087 - Низкое давление в рампе (проверить ТНВД, регулятор давления)
P0088 - Высокое давление в рампе (неисправен регулятор давления) 
P0089 - Неисправность регулятора давления топлива
P0191 - Датчик давления топлива - диапазон/производительность
P0192 - Низкий сигнал датчика давления топлива
P0193 - Высокий сигнал датчика давления топлива
P0201-P0208 - Неисправность форсунок (по цилиндрам)

СИСТЕМА EGR:
P0401 - Недостаточный поток рециркуляции ОГ
P0402 - Избыточный поток рециркуляции ОГ  
P0403 - Неисправность цепи рециркуляции ОГ

ТУРБОНАДДУВ:
P0234 - Турбонаддув - превышение предела
P0235 - Датчик давления наддува - неисправность цепи
P0299 - Турбонаддув - ниже порога`,
                    priority: 'critical',
                    created: '2025-01-05'
                },
                {
                    title: 'Диагностические процедуры Common Rail',
                    type: 'procedure',
                    content: `ПОСЛЕДОВАТЕЛЬНОСТЬ ДИАГНОСТИКИ COMMON RAIL:

1. ПОДКЛЮЧЕНИЕ СКАНЕРА:
- Использовать Bosch KTS или Launch X431
- Проверить связь со всеми блоками управления
- Считать коды ошибок из ECU двигателя

2. ПРОВЕРКА ДАВЛЕНИЯ ТОПЛИВА:
- Подключить манометр к рампе
- Давление на холостых: 280-320 бар
- Давление под нагрузкой: 1600-1800 бар
- Остаточное давление после остановки: не менее 100 бар

3. ТЕСТ ФОРСУНОК:
- Проверка сопротивления: 0.3-0.8 Ом
- Тест баланса (коррекция подачи)
- Допустимое отклонение: ±4 мг/такт
- Проверка герметичности при 300 бар`,
                    priority: 'critical',
                    created: '2025-01-08'
                }
            ],
            procedures: [
                {
                    title: 'Диагностика системы впрыска',
                    type: 'diagnostic',
                    content: 'Пошаговая диагностика проблем с системой впрыска Common Rail',
                    steps: [
                        'Подключить диагностический сканер Bosch KTS',
                        'Считать коды ошибок из блока управления двигателем',
                        'Проверить актуальные параметры: давление топлива, коррекция форсунок'
                    ]
                }
            ],
            tools: [
                {
                    title: 'Bosch KTS диагностический сканер',
                    type: 'equipment',
                    content: 'Профессиональный мультимарочный сканер для диагностики дизельных систем'
                }
            ]
        },
        responsibilities: [
            'Диагностика электронных систем управления',
            'Ремонт электрических цепей дизельных двигателей',
            'Программирование блоков управления'
        ],
        skills: [
            'Электротехника и электроника',
            'Компьютерная диагностика',
            'Знание протоколов CAN-шины'
        ],
        tools: [
            'Диагностические сканеры',
            'Осциллографы',
            'Мультиметры'
        ],
        procedures: [
            'Диагностика систем управления двигателем',
            'Программирование ECU'
        ]
    },

    'mehanik-tnvd': {
        title: 'Механик по ТНВД',
        description: 'Ремонт и обслуживание топливных насосов высокого давления',
        knowledgeBase: {
            documents: [
                {
                    title: 'Руководство по ремонту ТНВД PSG16',
                    type: 'manual',
                    content: `РЕМОНТ ТНВД PSG16 (Peugeot/Citroen 1.6 HDi):

ТЕХНИЧЕСКИЕ ХАРАКТЕРИСТИКИ:
- Давление: до 1600 бар
- Производительность: 16 л/мин при 6000 об/мин
- Регулятор давления: электромагнитный

ОСНОВНЫЕ НЕИСПРАВНОСТИ:
1. Износ плунжерных пар - падение давления
2. Неисправность регулятора давления - P0087/P0088
3. Износ кулачкового механизма - стук, вибрация

ПОРЯДОК РАЗБОРКИ:
1. Снять регулятор давления (момент 25 Нм)
2. Извлечь плунжерные пары специальным съемником
3. Снять кулачковый вал с подшипниками`,
                    priority: 'critical',
                    created: '2025-01-03'
                },
                {
                    title: 'Каталог запчастей ТНВД',
                    type: 'catalog',
                    content: `КАТАЛОГ ЗАПЧАСТЕЙ ОСНОВНЫХ ТНВД:

BOSCH CP1 (PSG16):
- Плунжерная пара: 0445010516 - 8500 руб
- Регулятор давления: 0281002493 - 12000 руб
- Ремкомплект уплотнений: F00RJ02697 - 3500 руб

BOSCH CP3 (VAG 44):
- Плунжерная пара: 0445010507 - 9200 руб
- Регулятор количества: 0928400617 - 15000 руб
- Корпус насоса: 0445010044 - 35000 руб`,
                    priority: 'high',
                    created: '2025-01-07'
                }
            ],
            procedures: [
                {
                    title: 'Испытание ТНВД на стенде Bosch EPS 815',
                    type: 'testing',
                    content: 'Полный цикл испытаний отремонтированного ТНВД',
                    steps: [
                        'Установить ТНВД на стенд с соблюдением момента затяжки',
                        'Подключить топливные магистрали высокого и низкого давления',
                        'Запустить программу испытаний для конкретной модели насоса'
                    ]
                }
            ],
            tools: [
                {
                    title: 'Стенд Bosch EPS 815 для испытания ТНВД',
                    type: 'equipment',
                    content: 'Профессиональный стенд для испытания и регулировки ТНВД всех типов'
                }
            ]
        },
        responsibilities: [
            'Диагностика и ремонт ТНВД всех типов',
            'Регулировка топливной аппаратуры',
            'Испытание отремонтированных агрегатов'
        ],
        skills: [
            'Знание конструкции ТНВД',
            'Работа с испытательными стендами',
            'Точная механическая обработка'
        ],
        tools: [
            'Стенды для проверки ТНВД',
            'Измерительные инструменты',
            'Ультразвуковые ванны'
        ],
        procedures: [
            'Диагностика ТНВД на стенде',
            'Ремонт плунжерных пар'
        ]
    },

    'mehanik-forsunki': {
        title: 'Механик по форсункам',
        description: 'Ремонт и диагностика дизельных форсунок Common Rail',
        knowledgeBase: {
            documents: [
                {
                    title: 'Технология ремонта форсунок Common Rail',
                    type: 'manual',
                    content: `РЕМОНТ ФОРСУНОК COMMON RAIL:

ТИПЫ ФОРСУНОК:
1. Bosch CRIN (1-4 поколения)
2. Delphi EJBR/EJDR серии  
3. Denso G3S/G4S серии

ОСНОВНЫЕ НЕИСПРАВНОСТИ:
- Закоксовывание распылителя (80% случаев)
- Износ иглы распылителя (15% случаев)
- Неисправность пьезо/электромагнитного привода (5% случаев)

ТЕХНОЛОГИЯ РАЗБОРКИ:
1. Снять электрический разъем и промаркировать
2. Зажать форсунку в специальное приспособление  
3. Отвернуть накидную гайку распылителя (момент 70 Нм)`,
                    priority: 'critical',
                    created: '2025-01-04'
                }
            ],
            procedures: [
                {
                    title: 'Испытание форсунок на стенде',
                    type: 'testing',
                    content: 'Полный цикл испытаний отремонтированных форсунок',
                    steps: [
                        'Установить форсунку в испытательное гнездо стенда',
                        'Подключить электрические разъемы согласно схеме',
                        'Заполнить систему калибровочной жидкостью'
                    ]
                }
            ],
            tools: [
                {
                    title: 'Стенд EPS 815 для испытания форсунок',
                    type: 'equipment',
                    content: 'Универсальный стенд для испытания всех типов дизельных форсунок'
                }
            ]
        },
        responsibilities: [
            'Диагностика форсунок на стенде',
            'Ультразвуковая очистка',
            'Замена распылителей и игл'
        ],
        skills: [
            'Знание конструкции форсунок',
            'Работа с испытательными стендами',
            'Точная настройка'
        ],
        tools: [
            'Стенды для форсунок',
            'Ультразвуковые ванны',
            'Микроскопы'
        ],
        procedures: [
            'Испытание форсунок',
            'Кодирование форсунок'
        ]
    },

    'manager': {
        title: 'Менеджер по продажам',
        description: 'Привлечение клиентов, продажа услуг ремонта и сопровождение сделок',
        knowledgeBase: {
            documents: [
                {
                    title: 'Скрипты продаж дизельных услуг',
                    type: 'sales_script',
                    content: `СКРИПТ РАБОТЫ С ВХОДЯЩИМИ ЗВОНКАМИ:

ЭТАП 1 - ПРИВЕТСТВИЕ:
"Добро пожаловать в W Garage! Меня зовут [ИМЯ], я помогу решить проблемы с вашим дизельным двигателем. Расскажите, что случилось с автомобилем?"

ЭТАП 2 - ВЫЯВЛЕНИЕ ПОТРЕБНОСТИ:
- Какая марка и модель автомобиля?
- Какой год выпуска и пробег?
- Какие симптомы неисправности?

ТИПИЧНЫЕ СИМПТОМЫ И ВОПРОСЫ:
"Двигатель не заводится" → Горят ли свечи накала? Есть ли топливо в баке?
"Потеря мощности" → На каких оборотах теряется мощность? Есть ли черный дым?`,
                    priority: 'critical',
                    created: '2025-01-15'
                }
            ],
            procedures: [
                {
                    title: 'Обработка входящего звонка',
                    type: 'customer_service',
                    content: 'Стандартный алгоритм работы с клиентами по телефону',
                    steps: [
                        'Приветствие и представление (в течение 3 гудков)',
                        'Выявление потребности клиента через открытые вопросы',
                        'Активное слушание и фиксация ключевой информации'
                    ]
                }
            ],
            tools: [
                {
                    title: 'CRM AmoCRM для ведения клиентов',
                    type: 'software',
                    content: 'Система управления взаимоотношениями с клиентами'
                }
            ]
        },
        responsibilities: [
            'Прием звонков и консультирование клиентов',
            'Ведение переговоров с потенциальными клиентами',
            'Составление коммерческих предложений'
        ],
        skills: [
            'Техника продаж',
            'Навыки переговоров',
            'Знание дизельного оборудования'
        ],
        tools: [
            'CRM-система',
            'IP-телефония',
            'WhatsApp Business'
        ],
        procedures: [
            'Прием и обработка входящих звонков',
            'Ведение переговоров с клиентами'
        ]
    },

    'fin-director': {
        title: 'Финансовый директор',
        description: 'Управление финансами компании, бюджетирование и финансовое планирование',
        responsibilities: [
            'Управление финансами и денежными потоками',
            'Составление бюджетов и финансовых планов',
            'Контроль за исполнением бюджета'
        ],
        skills: [
            'Финансовое планирование',
            'Бюджетирование',
            'Налоговое законодательство'
        ],
        tools: [
            '1С: Предприятие',
            'Банк-Клиент',
            'Excel (продвинутый уровень)'
        ],
        procedures: [
            'Ежедневный контроль денежных средств',
            'Еженедельные финансовые отчеты'
        ]
    }
};

// Функция для получения данных роли
function getRoleData(roleId) {
    return window.roleDatabase[roleId] || null;
}

// Функция для получения списка всех ролей
function getAllRoles() {
    return Object.keys(window.roleDatabase).map(roleId => ({
        id: roleId,
        title: window.roleDatabase[roleId].title,
        description: window.roleDatabase[roleId].description
    }));
}

// Функция поиска по базе знаний
function searchKnowledgeBase(query, roleId = null) {
    const results = [];
    const searchIn = roleId ? [window.roleDatabase[roleId]] : Object.values(window.roleDatabase);
    
    searchIn.forEach(role => {
        if (role.knowledgeBase) {
            // Поиск в документах
            role.knowledgeBase.documents?.forEach(doc => {
                if (doc.content.toLowerCase().includes(query.toLowerCase()) ||
                    doc.title.toLowerCase().includes(query.toLowerCase())) {
                    results.push({
                        type: 'document',
                        role: role.title,
                        title: doc.title,
                        content: doc.content,
                        priority: doc.priority
                    });
                }
            });
            
            // Поиск в процедурах
            role.knowledgeBase.procedures?.forEach(proc => {
                if (proc.content.toLowerCase().includes(query.toLowerCase()) ||
                    proc.title.toLowerCase().includes(query.toLowerCase())) {
                    results.push({
                        type: 'procedure',
                        role: role.title,
                        title: proc.title,
                        content: proc.content,
                        steps: proc.steps
                    });
                }
            });
        }
    });
    
    return results;
}

// Экспорт для использования в других модулях
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { getRoleData, getAllRoles, searchKnowledgeBase };
}
